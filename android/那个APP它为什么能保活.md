# 那个APP它为什么能保活

想必有些人一看到标题的已经知道是那个APP了。

对，就是那个安装包名称是Demo.apk的APP。

先说结论，那个APP(以下简称`它`), 在低版本的Android系统上是可以正常保活，但是高版本是不能保活的。随着Android版本越高，它的保活能力越差。其次，这个APP是无法上架的。再其次，它的技术都是开源的，并非它所说的黑科技。它所用到的技术就是这个[Marswin/MarsDaemon](https://github.com/Marswin/MarsDaemon?tab=readme-ov-file)，

很久很久以前，大约是写这篇文章的 `288000` 分钟前，我就在`Github` 看到过它了。当时出于好奇，下载下来在虚拟机上运行一下，确实可以实现保活。不过由于我的项目中并不需要这种功能，通常官方的保活方式已经足够，所以我没有深入研究。

后来，我多次在不同的地方见到它，直到前几天在QQ群里有一位好奇的群友再次提起，并询问它的原理。正好我有点空闲时间，于是决定反编译看看。

首先把它用`jadx-gui` 反编译，简单看了一下，也没看出特别地方。于是准备直接分析`so` 文件，但由于电脑没有安装相关工具，所以先拖到 AndroidStudio 看看代码。结果 AndroidStudio 在 Gradle 那里报错，注意到它的 TargetSdkVersion 是 28，那这就没啥奇怪的了。通常情况下，Android系统会根据 TargetSdkVersion 对低版本APP做兼容处理（最新的Android系统好像对此做出了限制），所以它完全可以按照 SDK 28 的版本去运行。

现在只需要从已有的技术里边找方案验证即可。 我直接就找到了这个[Marswin/MarsDaemon](https://github.com/Marswin/MarsDaemon?tab=readme-ov-file)，没别的原因，因为我以前就见到过。经验证，其结果表现一模一样。自此关于它的问题就基本结束了，至于其它功能各位可以自行查找。

它的技术如此简单（单纯针对它），为什么能一直引起注意？因为它不要脸啊。

它的营销方式可能是通过刷star来提升其可信度。一开始，他们可能会先通过各种手段刷大量的star，制造出一种受欢迎的假象。当有人被这种假象欺骗后，再促使这些受骗者也给它加上star，甚至让受骗者创建类似的项目，然后再继续刷star。

下面简介一下`Marswin/MarsDaemon`的技术：

## 内容由 AI 生成

`MarsDaemon` 是一个由 Marswin（也叫 Mars或Weishu）开发的 Android 开源项目，它旨在帮助开发者创建持久的 Android 后台服务，即使在系统强制杀掉进程后也能自动重启。这对于需要长期在后台运行的服务，比如计步器、推送服务或长连接的应用，尤其有用。

### 核心功能

`MarsDaemon` 主要提供以下几个核心功能：

1. **进程守护**：
   - `MarsDaemon` 使用“双进程守护”的策略，通过启动两个互相守护的子进程，确保即使一个进程被杀掉，另一个进程也会立即重启并重新启动被杀的进程。这使得应用可以在后台稳定运行。

2. **Native Daemon**：
   - 为了进一步提高守护进程的可靠性，`MarsDaemon` 还通过 JNI（Java Native Interface）启动一个 Native 进程，用于监视和守护主进程。Native 进程的守护能力通常比纯 Java 进程强，因为它在系统底层运行。`execlp("am", "am", "startservice", "--user", "0", "-n", pkg_svc_name, (char *) NULL);`

3. **广播和Alarm机制**：
   - `MarsDaemon` 利用系统的广播（BroadcastReceiver）和闹钟（AlarmManager）机制，在进程被杀死时，通过触发广播或闹钟事件来重新启动服务。

4. **高效节能**：
   - 尽管 `MarsDaemon` 可以有效守护进程，但它尽量避免过度消耗电池和系统资源。它的守护机制设计得较为轻量，减少对电量的消耗。

### 使用场景

`MarsDaemon` 适用于需要长时间运行的服务，例如：

- **实时通讯应用**：如即时消息（IM）应用，需要保持长连接，以确保消息的实时推送。
- **计步器**：需要在后台持续记录用户的运动数据，即使用户将应用切换到后台或设备进入睡眠状态。
- **定位服务**：持续的地理位置跟踪服务，尤其是那些需要在后台运行的 GPS 定位功能。

### 注意事项

- **系统优化机制**：现代 Android 系统（尤其是 Android 8.0 及以上）有很多电量优化机制，诸如 `Doze Mode`、后台限制等，这些机制会主动限制应用在后台的行为。虽然 `MarsDaemon` 能在一定程度上解决这个问题，但随着系统版本的提升，Google 也在加强对这种后台进程的限制。因此，使用 `MarsDaemon` 需要谨慎，尤其是在现代 Android 设备上。
  
- **电量消耗与用户体验**：长期在后台运行的服务可能会增加电量消耗，导致用户的负面体验。因此，在使用类似守护机制时，应该明确应用的需求，权衡守护机制与用户体验之间的关系。

- **合规性问题**：Google Play 对于这种在后台偷偷运行的守护服务有严格的规定，因此在使用 `MarsDaemon` 的同时，开发者需要确保应用符合 Google Play 的政策，以避免被下架或账号被封禁的风险。

### 总结

`MarsDaemon` 是一个强大且实用的工具，适合用于一些特殊需求的 Android 应用中，帮助它们在后台保持长时间的稳定运行。然而，开发者在使用时应特别注意系统版本的兼容性、电量消耗以及合规性，以避免影响用户体验和应用的合法性。
